<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Power4 Web - Partie</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/board.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="/static/js/script.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Power4 - Partie</h1>

      <!-- Infos joueurs -->
      <div class="players-info">
        <div class="player">
          <span class="player-token p1"></span>
          <strong>{{.Player1}}</strong>
        </div>
        <span class="vs">VS</span>
        <div class="player">
          <span class="player-token p2"></span>
          <strong>{{.Player2}}</strong>
        </div>
      </div>

      <!-- Tour actuel -->
      {{if not .Winner}}
      <p class="turn-indicator">
        Tour de :
        <strong class="{{if eq .CurrentPlayer 1}}player1-name current-player{{else}}player2-name current-player{{end}}">
        {{if eq .CurrentPlayer 1}}{{.Player1}}{{else}}{{.Player2}}{{end}}
        </strong>
      </p>
      {{end}}

      <!-- Difficulté -->
      <p>
        Niveau :
        <strong class="difficulty-badge {{.Difficulty}}">{{.Difficulty}}</strong>
      </p>
    </header>

    <!-- Indicateur de gravité -->
    <div class="gravity-indicator" style="margin: 10px 0; text-align:center;">
      {{if .GravityDown}}
        <span class="gravity-normal">⬇ Gravité normale</span>
      {{else}}
        <span class="gravity-inverse">⬆ Gravité inversée</span>
      {{end}}
    </div>

    <!-- Bloc résultat + boutons -->
    {{if or .Winner .Draw}}
    <div class="game-result-container">
      <div class="game-result-card neon-glow">
        <div class="result-icon">
          {{if .Winner}}
            <span class="icon-win">🏆</span>
          {{else if .Draw}}
            <span class="icon-draw">🤝</span>
          {{end}}
        </div>

        <h2 class="result-title">
          {{if .Winner}}Victoire !{{else}}Match nul !{{end}}
        </h2>
        <p class="result-player">
          {{if .Winner}}{{if eq .Winner 1}}{{.Player1}}{{else}}{{.Player2}}{{end}} a remporté la partie 🎉{{else}}Aucun gagnant cette fois-ci{{end}}
        </p>

        <div class="rematch-options">
          <form method="POST" action="/rematch">
            <button type="submit" name="type" value="revanche">🔁 Rejouer</button>
          </form>
          <form method="POST" action="/rematch">
            <button type="submit" name="type" value="new">🚀 Nouvelle Partie</button>
          </form>
        </div>
      </div>
    </div>
    {{end}}

    <!-- Plateau du jeu -->
    <div class="game-container">
      <form method="POST" action="/play">
        <input type="hidden" name="player1" value="{{.Player1}}">
        <input type="hidden" name="player2" value="{{.Player2}}">
        <input type="hidden" name="difficulty" value="{{.Difficulty}}">

        <!-- Ligne de boutons -->
        {{if not .Winner}}
        <div class="columns">
          {{range .ColRange}}
            <button type="submit" name="col" value="{{.}}">▼</button>
          {{end}}
        </div>
        {{end}}

        <!-- Grille du jeu -->
        <table class="board">
          {{range .Grid}}
            <tr>
              {{range .}}
                <td class="{{if eq .Value 1}}token1{{else if eq .Value 2}}token2{{end}}{{if .IsWinning}} winning-token{{end}}"></td>
              {{end}}
            </tr>
          {{end}}
        </table>
      </form>
    </div>
  </div>

  <!-- 🎉 Confetti JS déclenché si victoire -->
  {{if .Winner}}
  <script>
    setTimeout(() => {
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });
    }, 500);
  </script>
  {{end}}
</body>
</html>